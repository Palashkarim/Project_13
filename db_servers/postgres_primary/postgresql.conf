# =============================================================================
# PostgreSQL primary node configuration
# Goal: stable on a single home server, ready for TimescaleDB, WAL archiving,
# and optional replication. Tune conservatively; adjust for your hardware.
# =============================================================================

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------
listen_addresses = '*'           # or '127.0.0.1' if only local access
port = 5432
max_connections = 200            # raise if needed

#------------------------------------------------------------------------------
# AUTHENTICATION
#------------------------------------------------------------------------------
# Use pg_hba.conf for host-level access rules

#------------------------------------------------------------------------------
# MEMORY
#------------------------------------------------------------------------------
shared_buffers = 1GB             # ~25% of RAM (example for 4GB RAM -> 1GB)
work_mem = 16MB                  # per sort/agg; increase cautiously
maintenance_work_mem = 256MB     # for VACUUM/CREATE INDEX
effective_cache_size = 3GB       # ~75% of RAM

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL) / CHECKPOINTS
#------------------------------------------------------------------------------
wal_level = replica              # 'replica' ok for streaming standbys
max_wal_size = 4GB
min_wal_size = 512MB
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
synchronous_commit = on          # turn 'remote_write' if replicas later

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------
autovacuum = on
autovacuum_naptime = 10s
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
logging_collector = on
log_directory = 'logs'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 0
log_line_prefix = '%m [%p] %u@%d '

#------------------------------------------------------------------------------
# LOCALE / ENCODING
#------------------------------------------------------------------------------
client_min_messages = notice

#------------------------------------------------------------------------------
# EXTENSIONS (TimescaleDB)
#------------------------------------------------------------------------------
shared_preload_libraries = 'timescaledb'   # enable after installation
timescaledb.telemetry_level = 'off'

#------------------------------------------------------------------------------
# REPLICATION (Optional â€“ for /replica/)
#------------------------------------------------------------------------------
#archive_mode = on
#archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
#wal_compression = on
#max_wal_senders = 5
#wal_keep_size = 1024MB
